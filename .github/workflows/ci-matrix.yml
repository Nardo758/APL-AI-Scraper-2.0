name: Test Matrix

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Note: This workflow references GitHub Actions secrets (for example
# `${{ secrets.SUPABASE_ANON_KEY }}` or `${{ secrets.SNYK_TOKEN }}`). Those
# secrets are injected at runtime by GitHub Actions and may be flagged by
# some editor/schema checkers. Quoting the expressions reduces false
# positive warnings while keeping runtime behavior intact.

jobs:
  test-stubbed:
    name: Stubbed Tests (${{ matrix.os }} - Node ${{ matrix.node-version }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18.x, 20.x]

    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --no-audit --no-fund
      
    - name: Run linting
      run: npx eslint . --ext .js --max-warnings 0
      
    - name: Run unit tests (stubbed)
      run: npm test
      
    - name: Run integration tests (stubbed)
      run: npm run test:integration
      
    - name: Upload test results
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      with:
        name: test-results-${{ matrix.os }}-node${{ matrix.node-version }}
        path: |
          coverage/
        retention-days: 30

  test-integration:
    name: Integration Tests (Real Services)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
    
    - name: Use Node.js 20.x
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
      with:
        node-version: 20.x
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev python3
        npm ci --no-audit --no-fund
        
    - name: Wait for Redis
      run: |
        until redis-cli -h localhost -p 6379 ping | grep -q PONG; do
          echo "Waiting for Redis..."
          sleep 2
        done
        
    - name: Run tests with real services
      # Note: SUPABASE_URL and SUPABASE_ANON_KEY are provided via
      # GitHub Actions secrets/context in the repository settings.
      env:
        SUPABASE_URL: "${{ secrets.SUPABASE_URL }}"
        SUPABASE_ANON_KEY: "${{ secrets.SUPABASE_ANON_KEY }}"
        REDIS_URL: redis://localhost:6379
      run: |
        npm run test:all
        
    - name: Upload integration test results
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      with:
        name: integration-test-results
        path: coverage/
        retention-days: 30

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
    
    - name: Use Node.js 20.x
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
      with:
        node-version: 20.x
        cache: 'npm'
    
    - name: Run security audit
      run: npm audit --audit-level moderate
      
    - name: Run Snyk security scan
      uses: snyk/actions/node@v3
      # Note: SNYK_TOKEN is provided via GitHub Actions secrets/context. The
      # expression is quoted to reduce editor warnings and preserve runtime
      # behavior in GitHub Actions.
      env:
        SNYK_TOKEN: "${{ secrets.SNYK_TOKEN }}"
      with:
        args: --severity-threshold=high --sarif-file-output=snyk.sarif
        
    - name: Upload SARIF results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: snyk.sarif
